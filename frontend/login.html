<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Hastane Giriş</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding-top: 80px; background: #f5f5f5; margin:0;}
        .login-box { background: #fff; padding: 20px; display: inline-block; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
        input, select, button { display: block; margin: 10px auto; padding: 10px; width: 240px; }
        small { color:#666; }
        .banner { position: fixed; top:0; left:0; right:0; background:#0f172a; color:#e5e7eb; padding:10px; display:none; align-items:center; gap:10px; justify-content:center; }
        .banner button { margin:0 6px; padding:8px 12px; border:none; border-radius:8px; cursor:pointer; }
        .banner .go { background:#2563eb; color:#fff; }
        .banner .switch { background:#e11d48; color:#fff; }
    </style>
    <!-- Backend portunu burada ayarla -->
    <script>const BASE_URL = "http://localhost:8080";</script>
</head>
<body>

<!-- Zaten giriş varsa otomatik yönlendirme YOK; bunun yerine bu şerit gösterilir -->
<div id="sessionBanner" class="banner">
    <span id="bannerText">Zaten giriş yapılmış.</span>
    <button class="go" id="continueBtn">Devam Et</button>
    <button class="switch" id="switchBtn">Hesabı Değiştir</button>
</div>

<div class="login-box">
    <h2>Giriş Yap</h2>
    <input type="text" id="username" placeholder="Kullanıcı Adı" />
    <input type="password" id="password" placeholder="Şifre" />
    <select id="role">
        <option value="doctor">Doktor</option>
        <option value="patient">Hasta</option>
        <option value="admin">Admin</option>
    </select>
    <button id="loginBtn" type="button">Giriş Yap</button>
    <p id="message"></p>
    <small>Test: admin/1234 (admin) · doktor1/1234 (doctor) · hasta1/1234 (patient)</small>
</div>

<script>
    // Sayfa açılınca: logout’tan geldiysek mesaj göster, otomatik yönlendirme YOK
    document.addEventListener('DOMContentLoaded', () => {
      const p = new URLSearchParams(location.search);
      if (p.get('logout') === '1') {
        try { localStorage.removeItem('user'); sessionStorage.clear(); } catch(e){}
        history.replaceState({}, '', 'login.html');
        const m = document.getElementById('message');
        if (m) { m.style.color = 'green'; m.textContent = 'Çıkış yapıldı.'; }
      }

      // Zaten girişli ise şerit göster (otomatİk geçiş YAPMA)
      try {
        const uStr = localStorage.getItem('user');
        if (uStr) {
          const u = JSON.parse(uStr);
          const banner = document.getElementById('sessionBanner');
          const text = document.getElementById('bannerText');
          text.textContent = `Zaten giriş yapılmış: @${u.username} • ${u.role}`;
          banner.style.display = 'flex';

          document.getElementById('continueBtn').onclick = () => go(u.role);
          document.getElementById('switchBtn').onclick = () => {
            try { localStorage.removeItem('user'); sessionStorage.clear(); } catch(e){}
            banner.style.display = 'none';
            // alanları temizle
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
          };
        }
      } catch {}
    });

    function go(role) {
      if (role === 'doctor')       location.href = 'doctor.html';
      else if (role === 'patient') location.href = 'patient.html';
      else if (role === 'admin')   location.href = 'admin.html';
    }

    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const roleSel  = document.getElementById('role').value;
      const msg = document.getElementById('message');
      msg.style.color = '#111';
      msg.textContent = 'Giriş deneniyor...';

      try {
        const res = await fetch(`${BASE_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, role: roleSel })
        });
        const data = await res.json();

        if (data.status === 'success') {
          localStorage.setItem('user', JSON.stringify({ username: data.username, role: data.role }));
          go(data.role);
        } else {
          msg.style.color = 'red';
          msg.textContent = data.message || 'Giriş başarısız.';
        }
      } catch (e) {
        msg.style.color = 'red';
        msg.textContent = 'Sunucuya ulaşılamadı.';
      }
    }

    // Buton ve Enter kablolaması
    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('password').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') login(); });
    window.login = login; // inline kullanım için
</script>
</body>
</html>
