<!DOCTYPE html><html lang="tr"><head>
  <meta charset="UTF-8"><title>OR Router</title>
  <style>
    body{font-family:Arial,sans-serif;padding:24px;background:#f7fafc}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:16px}
    select,button{padding:10px;border:1px solid #e5e7eb;border-radius:8px}
    button{background:#1d4ed8;color:#fff;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left}
    video{width:100%;max-height:360px;background:#000;border-radius:10px}
    .bad{color:#b91c1c}
    .ghost{background:#f1f5f9;color:#111827;border:none}
  </style></head><body>
<script>const BASE_URL="http://localhost:8080";</script>
<header>
  <h2>OR Router (NuCLeUS benzeri)</h2>
  <div>
    <button class="ghost" onclick="location.href='sources.html'">Sources</button>
    <button class="ghost" onclick="location.href='presets.html'">Presets</button>
    <button class="ghost" onclick="location.href='audit.html'">Audit</button>
    <button class="ghost" onclick="location.href='admin.html'">Admin</button>
  </div>
</header>

<div class="card">
  <h3>Yönlendir</h3>
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <select id="room"></select>
    <select id="source"></select>
    <button onclick="route()">Odaya Kaynağı Bağla</button>
  </div>
  <p id="status"></p>
</div>

<div class="card">
  <h3>Seçili Odanın Aktif Kaynağı (Önizleme)</h3>
  <video id="player" controls></video>
</div>

<div class="card">
  <h3>Tüm Odaların Aktif Yönlendirmeleri</h3>
  <table><thead><tr><th>Oda</th><th>Kaynak</th><th>Güncelleme</th></tr></thead><tbody id="routes"></tbody></table>
</div>

<script>
  const user=JSON.parse(localStorage.getItem('user')||'{"username":"admin"}');
  const roomSel=document.getElementById('room');
  const srcSel=document.getElementById('source');
  const player=document.getElementById('player');

  function loadRooms(){ fetch(`${BASE_URL}/or/rooms`).then(r=>r.json()).then(list=>{
    roomSel.innerHTML=''; list.forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=r.name; roomSel.appendChild(o); });
    updatePreview();
  });}

  function loadSources(){ fetch(`${BASE_URL}/or/sources`).then(r=>r.json()).then(list=>{
    srcSel.innerHTML=''; list.forEach(s=>{
      const o=document.createElement('option'); o.value=s.id;
      o.textContent = s.name + (s.online ? '' : ' (offline)');
      o.dataset.url=s.url; o.dataset.online=s.online; srcSel.appendChild(o);
    });
  });}

  function loadRoutesTable(){
    Promise.all([fetch(`${BASE_URL}/or/routes`).then(r=>r.json()),
                 fetch(`${BASE_URL}/or/rooms`).then(r=>r.json()),
                 fetch(`${BASE_URL}/or/sources`).then(r=>r.json())])
    .then(([routes,rooms,sources])=>{
      const rm={}, sm={}; rooms.forEach(x=>rm[x.id]=x.name); sources.forEach(x=>sm[x.id]=x.name+(x.online?'':' (offline)'));
      const tb=document.getElementById('routes'); tb.innerHTML='';
      routes.forEach(rt=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${rm[rt.roomId]||rt.roomId}</td><td>${sm[rt.sourceId]||rt.sourceId}</td><td>${rt.datetime}</td>`;
        tb.appendChild(tr);
      });
    });
  }

  function updatePreview(){
    const rid=roomSel.value; if(!rid) return;
    fetch(`${BASE_URL}/or/route/${rid}`).then(r=>r.json()).then(data=>{
      const src=data.source; player.src=src&&src.url?src.url:''; player.load();
    });
    loadRoutesTable();
  }

  function route(){
    const rid=Number(roomSel.value), sid=Number(srcSel.value);
    const online = srcSel.selectedOptions[0].dataset.online === 'true';
    if(!online){ const s=document.getElementById('status'); s.className='bad'; s.textContent='Seçilen kaynak OFFLINE. Route engellendi.'; return; }
    fetch(`${BASE_URL}/or/route`, {method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({roomId:rid, sourceId:sid, actor:user?.username||'admin'})})
    .then(r=>{ if(!r.ok) return r.text().then(t=>{throw new Error(t)}); return r.json(); })
    .then(()=>{ document.getElementById('status').className=''; document.getElementById('status').textContent='Yönlendirme güncellendi.'; updatePreview(); })
    .catch(e=>{ document.getElementById('status').className='bad'; document.getElementById('status').textContent='Hata: '+e.message; });
  }

  roomSel.addEventListener('change', updatePreview);
  loadRooms(); loadSources(); loadRoutesTable();
</script>
</body></html>
